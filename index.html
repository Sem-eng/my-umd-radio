<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Моя Удмуртия</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #222222);
            --button-color: var(--tg-theme-button-color, #248bcf);
            --button-text: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f4f4f4);
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: sans-serif;
            display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0;
        }
        .player-card {
            text-align: center; padding: 40px; border-radius: 35px;
            background: var(--secondary-bg); width: 260px;
        }
        .btn-container { position: relative; width: 120px; height: 120px; margin: 30px auto; }
        #playBtn {
            position: relative; z-index: 2; width: 100px; height: 100px; border-radius: 50%;
            border: none; background: var(--button-color); color: var(--button-text);
            font-size: 16px; font-weight: bold; cursor: pointer;
        }
        .pulse {
            position: absolute; width: 100px; height: 100px; border-radius: 50%;
            background: var(--button-color); opacity: 0; left: 10px; top: 10px;
        }
        .playing .pulse { animation: pulse-animation 2s infinite; }
        @keyframes pulse-animation {
            0% { transform: scale(1); opacity: 0.5; }
            100% { transform: scale(1.7); opacity: 0; }
        }
        #statusText { font-size: 12px; font-weight: bold; opacity: 0.6; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div class="player-card">
        <div id="statusText">НАЖМИТЕ PLAY</div>
        <div class="btn-container" id="container">
            <div class="pulse"></div>
            <button id="playBtn">PLAY</button>
        </div>
        <div style="font-size: 18px; font-weight: bold;">Моя Удмуртия</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();

        const streamUrl = "https://cors-anywhere.wcx.cloud/http://radio.myudm.ru:10010/efir";
        let audio = new Audio();
        audio.crossOrigin = "anonymous";

        const btn = document.getElementById('playBtn');
        const container = document.getElementById('container');
        const status = document.getElementById('statusText');

        btn.onclick = function() {
            if (audio.paused) {
                status.innerText = "БУФЕРИЗАЦИЯ...";
                btn.disabled = true;
                btn.style.opacity = "0.5";

                audio.src = streamUrl;
                audio.load();

                // ХАК: Ждем события canplaythrough (когда браузер считает, что данных хватит для плавного проигрывания)
                const playOnReady = () => {
                    audio.play().then(() => {
                        btn.disabled = false;
                        btn.style.opacity = "1";
                        btn.innerText = "STOP";
                        status.innerText = "• В ЭФИРЕ";
                        container.classList.add('playing');
                    });
                    audio.removeEventListener('canplaythrough', playOnReady);
                };

                audio.addEventListener('canplaythrough', playOnReady);
                
                // Таймаут на случай, если событие не пришло за 10 секунд
                setTimeout(() => {
                    if (audio.paused && btn.disabled) {
                        playOnReady();
                    }
                }, 10000);

            } else {
                audio.pause();
                audio.src = ""; // Полная очистка для сброса буфера
                btn.innerText = "PLAY";
                status.innerText = "ПАУЗА";
                container.classList.remove('playing');
                btn.disabled = false;
                btn.style.opacity = "1";
            }
        };

        audio.onerror = () => {
            status.innerText = "ОШИБКА СЕТИ";
            btn.disabled = false;
            btn.style.opacity = "1";
        };
    </script>
</body>
</html>
