<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; font-family: sans-serif;
        }
        .card { text-align: center; background: var(--tg-theme-secondary-bg-color, #f4f4f4); padding: 40px; border-radius: 35px; width: 250px; }
        #playBtn {
            width: 100px; height: 100px; border-radius: 50%; border: none;
            background: var(--tg-theme-button-color, #248bcf);
            color: var(--tg-theme-button-text-color, #fff);
            font-size: 16px; font-weight: bold; cursor: pointer; margin: 20px 0;
            transition: opacity 0.3s;
        }
        #status { font-size: 11px; font-weight: bold; opacity: 0.6; height: 20px; }
        .progress-bar { width: 100%; height: 4px; background: #ddd; margin-top: 10px; border-radius: 2px; overflow: hidden; display: none; }
        .progress-fill { height: 100%; background: #248bcf; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="card">
        <div id="status">ГОТОВ</div>
        <div class="progress-bar" id="pBar"><div class="progress-fill" id="pFill"></div></div>
        <button id="playBtn">PLAY</button>
        <div style="font-size: 18px; font-weight: bold;">Моя Удмуртия</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const streamUrl = "https://cors-anywhere.wcx.cloud/http://radio.myudm.ru:10010/efir";
        let audio = new Audio();
        audio.crossOrigin = "anonymous";

        const btn = document.getElementById('playBtn');
        const status = document.getElementById('status');
        const pBar = document.getElementById('pBar');
        const pFill = document.getElementById('pFill');

        let isBuffering = false;

        btn.onclick = function() {
            if (audio.paused) {
                startBuffering();
            } else {
                stopAudio();
            }
        };

        function startBuffering() {
            isBuffering = true;
            btn.disabled = true;
            btn.style.opacity = "0.5";
            pBar.style.display = "block";
            status.innerText = "НАПОЛНЕНИЕ БУФЕРА...";
            
            audio.src = streamUrl;
            audio.load();

            // Следим за прогрессом загрузки
            const checkBuffer = () => {
                if (audio.buffered.length > 0) {
                    const bufferedTime = audio.buffered.end(0) - audio.buffered.start(0);
                    const percent = Math.min((bufferedTime / 8) * 100, 100); // Ждем 8 секунд потока
                    pFill.style.width = percent + "%";

                    if (bufferedTime >= 6) { // Если накопили 6 секунд - стартуем
                        audio.play();
                        onStarted();
                        audio.removeEventListener('progress', checkBuffer);
                    }
                }
            };

            audio.addEventListener('progress', checkBuffer);
        }

        function onStarted() {
            isBuffering = false;
            btn.disabled = false;
            btn.style.opacity = "1";
            btn.innerText = "STOP";
            status.innerText = "• В ЭФИРЕ";
            pBar.style.display = "none";
            tg.HapticFeedback.impactOccurred('medium');
        }

        function stopAudio() {
            audio.pause();
            audio.src = ""; 
            btn.innerText = "PLAY";
            status.innerText = "ПАУЗА";
            pBar.style.display = "none";
            pFill.style.width = "0%";
            tg.HapticFeedback.impactOccurred('light');
        }

        audio.onerror = () => {
            status.innerText = "ОШИБКА ПРОКСИ";
            stopAudio();
        };
    </script>
</body>
</html>
