<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Радио Моя Удмуртия</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #000000);
            --btn-color: var(--tg-theme-button-color, #248bcf);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --hint: var(--tg-theme-hint-color, #999);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; overflow: hidden;
        }

        .card {
            text-align: center;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            padding: 40px;
            border-radius: 35px;
            width: 260px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        #playBtn {
            width: 110px; height: 110px; border-radius: 50%; border: none;
            background: var(--btn-color); color: var(--btn-text);
            font-size: 18px; font-weight: bold; cursor: pointer; margin: 25px 0;
            transition: transform 0.1s, opacity 0.3s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        #playBtn:active { transform: scale(0.9); }
        #playBtn:disabled { opacity: 0.5; cursor: not-allowed; }

        .playing { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(36, 139, 207, 0.5); }
            70% { box-shadow: 0 0 0 25px rgba(36, 139, 207, 0); }
            100% { box-shadow: 0 0 0 0 rgba(36, 139, 207, 0); }
        }

        #status { font-size: 12px; font-weight: bold; color: var(--hint); letter-spacing: 1px; }
    </style>
</head>
<body>

    <div class="card">
        <div id="status">ГОТОВ К ЭФИРУ</div>
        <button id="playBtn">PLAY</button>
        <div style="font-size: 19px; font-weight: 800;">Моя Удмуртия</div>
        <div style="font-size: 13px; opacity: 0.6; margin-top: 5px;">Прямой HTTP поток</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Оригинальная HTTP ссылка
        const streamUrl = "https://cors-anywhere.wcx.cloud/http://radio.myudm.ru:10010/efir";
        
        let audio = new Audio();
        audio.preload = "auto";
        // Важно: на некоторых Android без этого атрибута HTTP не заиграет
        audio.setAttribute('mixed-content', 'always'); 

        const btn = document.getElementById('playBtn');
        const status = document.getElementById('status');

        btn.onclick = function() {
            if (audio.paused) {
                status.innerText = "ПОДКЛЮЧЕНИЕ...";
                btn.disabled = true;

                // Сбрасываем и устанавливаем поток заново
                audio.src = streamUrl;
                audio.load();

                // Ждем начала воспроизведения
                audio.play()
                    .then(() => {
                        btn.disabled = false;
                        btn.innerText = "STOP";
                        btn.classList.add('playing');
                        status.innerText = "• В ЭФИРЕ";
                        tg.HapticFeedback.impactOccurred('medium');
                    })
                    .catch(e => {
                        btn.disabled = false;
                        status.innerText = "ОШИБКА HTTPS BLOCK";
                        console.error("Mixed Content Error:", e);
                        alert("Ошибка: Браузер блокирует HTTP. Попробуйте открыть через Chrome.");
                    });
            } else {
                audio.pause();
                audio.src = ""; // Обнуляем, чтобы не грузить трафик
                btn.innerText = "PLAY";
                btn.classList.remove('playing');
                status.innerText = "ПАУЗА";
                tg.HapticFeedback.impactOccurred('light');
            }
        };

        // Если возникают рывки (буферизация)
        audio.onwaiting = () => {
            status.innerText = "БУФЕРИЗАЦИЯ...";
        };

        audio.onplaying = () => {
            status.innerText = "• В ЭФИРЕ";
        };

        // Обработка критической ошибки
        audio.onerror = () => {
            status.innerText = "ОШИБКА ПОТОКА";
            btn.disabled = false;
        };
    </script>
</body>
</html>

