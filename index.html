<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; font-family: -apple-system, sans-serif;
        }
        .card { text-align: center; background: var(--tg-theme-secondary-bg-color, #f5f5f5); padding: 40px; border-radius: 30px; width: 250px; }
        #playBtn {
            width: 100px; height: 100px; border-radius: 50%; border: none;
            background: #248bcf; color: #fff; font-size: 16px; font-weight: bold;
            cursor: pointer; margin: 20px 0; outline: none;
        }
        #status { font-size: 12px; font-weight: bold; opacity: 0.6; text-transform: uppercase; }
        .playing { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(36, 139, 207, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(36, 139, 207, 0); }
            100% { box-shadow: 0 0 0 0 rgba(36, 139, 207, 0); }
        }
    </style>
</head>
<body>
    <div class="card">
        <div id="status">ГОТОВ</div>
        <button id="playBtn">PLAY</button>
        <div style="font-size: 18px; font-weight: bold;">Моя Удмуртия</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Ваша ссылка
        const targetUrl = "http://radio.myudm.ru:10010/efir";
        
        // Используем более мощный прокси-сервис для стриминга
        // Этот прокси лучше справляется с бинарными данными
        const proxyUrl = "https://corsproxy.io/?" + encodeURIComponent(targetUrl);
        
        let audio = new Audio();
        audio.crossOrigin = "anonymous";

        const btn = document.getElementById('playBtn');
        const status = document.getElementById('status');

        btn.onclick = function() {
            if (audio.paused) {
                status.innerText = "ЗАГРУЗКА...";
                
                // Переподключаем src, чтобы поток всегда был свежим
                audio.src = proxyUrl;
                
                // Настройка буферизации для мобильных
                audio.preload = "auto";
                
                audio.play()
                    .then(() => {
                        status.innerText = "• В ЭФИРЕ";
                        btn.innerText = "STOP";
                        btn.classList.add('playing');
                        tg.HapticFeedback.impactOccurred('medium');
                    })
                    .catch(e => {
                        status.innerText = "ОШИБКА ПРОКСИ";
                        console.error(e);
                    });
            } else {
                audio.pause();
                audio.src = ""; // Важно: полностью обрываем поток
                status.innerText = "ПАУЗА";
                btn.innerText = "PLAY";
                btn.classList.remove('playing');
                tg.HapticFeedback.impactOccurred('light');
            }
        };

        // Если возникают заикания, браузер сам вызовет это событие
        audio.onwaiting = () => { status.innerText = "БУФЕРИЗАЦИЯ..."; };
        audio.onplaying = () => { status.innerText = "• В ЭФИРЕ"; };
    </script>
</body>
</html>
